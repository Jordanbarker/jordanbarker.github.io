<html>
<head>
<title>Pong Reinforment Learning Agent</title>
<style>
    body {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        height: 200vh;
        margin: 0;
        background-color: rgb(242, 239, 239);
        font-family: 'Roboto', sans-serif;
        color: #333;
    }
    #scoreboard {
        display: flex;
        justify-content: space-around;
        width: 100%;
        max-width: 800px;
        font-size: 27px;
        margin-top: 10px;
    }
    #pongCanvas {
        background-color: #333;
        border: 2px solid #fff;
        width: 100%;
        max-width: 800px;
        height: 40vh;
        z-index: 1;
        border-radius: 10px;

    }
    #main-button-container {
        display: flex; 
        flex-direction: column;
        position: absolute;
        top: 25%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        gap: 20px;
    }
    .game-button {
        font-size: 24px;
        padding: 20px 40px;
        background-color: #fff;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s;
    }
    .game-button:hover {
        background-color: #007BFF;
        color: white;
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    .game-button:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5);
    }
    #fps-buttons, #button-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }

    #fps-buttons button, #button-container button, #network-visualization button {
        font-size: 18px;
        padding: 10px 20px;
        background-color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s;
    }

    #fps-buttons button:hover, #button-container button:hover, #network-visualization button:hover {
        background-color: #007BFF;
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Ensure the selected class has higher specificity */
    #fps-buttons button.selected, #button-container button.selected, #network-visualization button.selected {
        background-color: #007BFF !important;
        color: white !important;
    }

    #fps-buttons, #network-button {
        display: none; /* Initially hide the fps-buttons */
    }

    #network-visualization {
        display: flex;
        justify-content: center;
        flex-direction: column;
        padding-bottom: 10px;
        align-items: center;
        width: 100%;
        height: 100vh;
        background-color: #e0e0e0;
        margin-top: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    #chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        max-width: 800px;
        margin-top: 10px;
    }
    #chart-container canvas  {
        margin: 0 10px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .selected {
        background-color: #007BFF;
        color: white;
    }
    .label {
        text-anchor: middle;
    }
    .description {
        fill: black;
        text-anchor: middle;
    }
    #brain-attributes {
        text-decoration: none;
    }
    .circle {
        stroke: #000;
        stroke-width: 1px;
    }
    .line {
        stroke: #000;
        stroke-width: 1px;
    }
</style>

</head>
<body>
<!-- <div id="title">Pong Reinforment Learning Agent</div> -->
<div id="scoreboard">
    <div id="playerScore">Player: 0</div>
    <div id="computerScore">Computer: 0</div>
</div>
<canvas id="pongCanvas" width="800" height="400" tabindex="0"></canvas>
<div id="main-button-container">
    <button id="playButton" class="game-button">Play</button>
    <button id="trainButton" class="game-button">Train Agent</button>
</div>
<div id="fps-buttons">
    <button onclick="setFrameRate(1)">1 FPS</button>
    <button onclick="setFrameRate(10)">10 FPS</button>
    <button onclick="setFrameRate(60)">60 FPS</button>
    <button onclick="setFrameRate(1000)">1000 FPS</button>
</div>
<!-- <button id="playButton" class="game-button">Play</button> -->
<div id="network-visualization">
    <svg id="network-svg"></svg>
    <button id="network-button" class="network-button">Pause Visualization</button>
</div>
<div id="brain-attributes"></div>
<div id="chart-container"><canvas id="rewardChart"></canvas></div>
<div id="chart-container"><canvas id="lossChart"></canvas></div>
<div id="button-container">
    <button onclick="savenet()">Save Network</button>
    <button id="loadNetButton">Load Network</button>
    <input type="file" id="fileInput" accept=".json" style="display: none;">
    <textarea id="network-text" style="display:none;"></textarea>
</div>
<p id="hit-miss"></p>
</body>

<script src="convnetjs/convnet-min.js"></script>
<script src="convnetjs/util.js"></script>
<script src="convnetjs/deepqlearn.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    const rewardChart = new Chart(document.getElementById('rewardChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{label: 'Average Reward',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        fill: false}]
        },
        options: {
            animation: false,
            scales: {
                x: {title: {display: true,
                            text: 'Time'}},
                y: {title: {display: true,
                            text: 'Value'}}}
        }
    });
    const lossChart = new Chart(document.getElementById('lossChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{label: 'Average Loss',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        fill: false}]
        },
        options: {
            animation: false,
            scales: {
                x: {title: {display: true,
                            text: 'Time'}},
                y: {title: {display: true,
                            text: 'Value'}}
            }
        }
    });

    function addData() {
        const currentTime = new Date().toLocaleTimeString()
        rewardChart.data.labels.push(currentTime);
        // console.log(brain.average_reward_window)
        rewardChart.data.datasets[0].data.push(brain.average_reward_window.sum / brain.average_reward_window.size);
        rewardChart.update();

        lossChart.data.labels.push(currentTime);
        lossChart.data.datasets[0].data.push(brain.average_loss_window.sum / brain.average_loss_window.v.length);
        lossChart.update();

        if (brain.epsilon <= opt.epsilon_min) {
            hit_miss = (hitCount / missCount).toFixed(2);
        } else {
            hit_miss = 'Will calculate once the epsilon reaches its minimum'
        }

        const brainAttributes = [
            `age: ${brain.age}`,
            `epsilon: ${brain.epsilon.toFixed(2)}`,
            `hit/miss ratio: ${hit_miss}`,
        ];

        const brainAttributesList = brainAttributes.map(attr => `<li>${attr}</li>`).join('');
            
        document.getElementById('brain-attributes').innerHTML = `<ul>${brainAttributesList}</ul>`;
    }
    
    // RL Agent Settings
    var num_inputs = 5; // ball.x, ball.y, ball.dx, ball.dy, computer.y
    var num_actions = 3; // up, down, stay
    var temporal_window = 0; // amount of temporal memory. 0 = agent lives in-the-moment :)
    var network_size = num_inputs*temporal_window + num_actions*temporal_window + num_inputs;
    var layer_defs = [];
        layer_defs.push({type:'input', out_sx:1, out_sy:1, out_depth:network_size});
        
        // layer_defs.push({type:'fc', num_neurons: 16, activation:'relu'});
        // layer_defs.push({type:'fc', num_neurons: 12, activation:'relu'});
        // layer_defs.push({type:'fc', num_neurons: 8, activation:'relu'});
        
        layer_defs.push({type:'fc', num_neurons: 8, activation:'relu'});
        layer_defs.push({type:'fc', num_neurons: 16, activation:'relu'});
        layer_defs.push({type:'fc', num_neurons: 16, activation:'relu'});
        layer_defs.push({type:'fc', num_neurons: 8, activation:'relu'});
        // layer_defs.push({type:'fc', num_neurons: 6, activation:'relu'});
        // layer_defs.push({type:'fc', num_neurons: 4, activation:'relu'});
        layer_defs.push({type:'regression', num_neurons:num_actions});

    var opt = {};
        opt.temporal_window = temporal_window;
        opt.experience_size = 30000;
        opt.start_learn_threshold = 50;
        opt.gamma = 0.7;
        opt.learning_steps_total = 1000000;
        opt.learning_steps_burnin = 50;
        opt.epsilon_min = 0.05;
        opt.epsilon_test_time = 0.0; // No random moves when learning == False
        opt.layer_defs = layer_defs;
        // opt.tdtrainer_options = {learning_rate:0.005, momentum:0.01, batch_size: 16, l2_decay:0.1, eps:.001};
        opt.tdtrainer_options = {learning_rate:0.0003, momentum:0.01, batch_size: 8, l2_decay:0.01};
    var brain = new deepqlearn.Brain(num_inputs, num_actions, opt);
    var action = 0;
    var reward = 0;
    var missCount = 1;
    var hitCount = 1;

    // Game settings
    const paddleWidth = 10;
    const paddleHeight = 80;
    const paddleSpeed = 7;
    const ballSpeed = 7;
    var frame = 0
    let pauseFrames = 0;
    const pauseDuration = 15; // Number of frames to pause and change ball color
    let ballColor = "#FFF";
    let playerColor = "#1b98e0" // blue
    let computerColor = "#f26a8d" // world domination red


    function setFrameRate(fps) {
        clearInterval(gameLoopInterval);
        intervalTime = 1000 / fps;
        gameLoopInterval = setInterval(gameLoop, intervalTime);
        fpsButtons.forEach(function(button) {
            button.classList.remove('selected');
        });
        event.target.classList.add('selected');
    }

    playNetworkVisualization = true
    function pauseNetworkVisualization() {
        if (playNetworkVisualization) {
            playNetworkVisualization = false;
            event.target.classList.add('selected');
        } else {
            playNetworkVisualization = true;
            event.target.classList.remove('selected');
        }
    }

    const canvas = document.getElementById("pongCanvas");
    const context = canvas.getContext("2d");

    function resizeCanvas() {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
    }
    
    const networkVisualization = document.getElementById("network-visualization");
    function resizeNtworkVisualization() {
        networkVisualization.width = canvas.offsetWidth + 100;
        networkVisualization.height = canvas.offsetHeight;
    }

    window.addEventListener('resize', resizeNtworkVisualization);
    window.addEventListener('resize', resizeCanvas);
    resizeNtworkVisualization();
    resizeCanvas();
    
    const playerPaddle = {
        x: 10,
        y: (canvas.height - paddleHeight) / 2,
        width: paddleWidth,
        height: paddleHeight,
        radius: 5,
    };

    const computerPaddle = {
        x: canvas.width - paddleWidth - 10,
        y: (canvas.height - paddleHeight) / 2,
        width: paddleWidth,
        height: paddleHeight,
        radius: 5,
    };

    const ball = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        radius: 7,
        dx: ballSpeed,
        dy: ballSpeed,
        initialSpeed: ballSpeed / 4,
        speed: ballSpeed / 2,
        maxSpeed: ballSpeed,
        speedIncrement: 0.1
    };
    
    function calculateLayerPositions(layers) {
        const positions = [];
        layers.forEach((layer, layerIndex) => {
            if (layer.layer_type !== 'relu' && layer.layer_type !== 'regression' ) {
                const layerX = margin.left + layerSpacing * (positions.length + 1);
                const nodeSpacing = (height - margin.top - margin.bottom) / (layer.out_act.w.length + 1);
                const layerPositions = Array.from(layer.out_act.w).map((weight, weightIndex) => ({
                    x: layerX,
                    y: margin.top + nodeSpacing * (weightIndex + 1),
                    weight,
                    layer_type: layer.layer_type
                }));
                positions.push({ positions: layerPositions, layer_type: layer.layer_type, x: layerX });
            }
        });
        return positions;
    }

    function drawNetwork(layers) {
        width = networkVisualization.width;
        height = networkVisualization.height;
        margin = { top: 10, right: 50, bottom: 10, left: 50 };

        svg = d3.select('#network-svg')
            .attr('width', width)
            .attr('height', height);

        const numOfLayers = brain.value_net.layers.filter(layer => layer.layer_type !== 'relu' && layer.layer_type !== 'regression').length;
        layerSpacing = (width - margin.left - margin.right) / (numOfLayers + 1);
        const maxWeightCount = Math.max(...layers.map(layer => layer.out_act.w.length));
        const nodeSpacing = (height - margin.top - margin.bottom) / (maxWeightCount + 1);
        const layerPositions = calculateLayerPositions(layers)

        // Draw lines between neighboring layers
        for (let i = 0; i < layerPositions.length - 1; i++) {
            const currentLayer = layerPositions[i].positions;
            const nextLayer = layerPositions[i + 1].positions;
            
            currentLayer.forEach(currentNode => {
                nextLayer.forEach(nextNode => {
                    svg.append('line')
                    .attr('x1', currentNode.x)
                    .attr('y1', currentNode.y)
                    .attr('x2', nextNode.x)
                    .attr('y2', nextNode.y)
                    .attr('class', 'line');
                });
            });
        }

        const firstLayer = layerPositions[0].positions;
        const firstLayerLabels = ["ball.x", "ball.y", "ball.dx", "ball.dy", "computer.y"];

        const lastLayerIndex = layerPositions.length - 1;
        const lastLayer = layerPositions[lastLayerIndex].positions;
        const lastLayerLabels = ["Stay", "Down", "Up"];

        const colorScale = d3.scaleLinear()
            .domain([d3.min(lastLayer.map(d => d.weight)), d3.max(lastLayer.map(d => d.weight))])
            .range([0, 1]);

        svg.selectAll('.circle')
            .data(layerPositions.flatMap(d => d.positions))
            .enter()
            .append('circle')
            .attr('class', 'circle')
            .attr('cx', d => d.x)
            .attr('cy', d => d.y)
            // .attr('r', d => layerPositions[lastLayerIndex].positions.includes(d) ? 25 : 10)
            .attr('r', d => 10)
            .attr('fill', d => {
                if (layerPositions[lastLayerIndex].positions.includes(d)) {
                    return d.weight > 0 ? d3.interpolateBlues(colorScale(d.weight)) : d3.interpolateOranges(colorScale(-d.weight));
                }
                return d.weight > 0 ? d3.interpolateBlues(d.weight) : d3.interpolateOranges(-d.weight);
            });

        svg.selectAll('.first-layer-text')
            .data(firstLayer)
            .enter()
            .append('text')
            .attr('class', 'first-layer-text')
            .attr('x', d => d.x - 130)
            .attr('y', d => d.y + 5)
            .attr('text-anchor', 'left')
            .text((d, i) => firstLayerLabels[i])
            .style('font-size', '22px')
            .style('font-weight', '800')
            .style('fill', '#000')
            .style('stroke', '#fff')
            .style('stroke-width', '3px')
            .style('paint-order', 'stroke');

        svg.selectAll('.last-layer-text')
            .data(lastLayer)
            .enter()
            .append('text')
            .attr('class', 'last-layer-text')
            .attr('x', d => d.x + 20)
            .attr('y', d => d.y + 5)
            .attr('text-anchor', 'left')
            .text((d, i) => lastLayerLabels[i])
            .style('font-size', '22px')
            .style('font-weight', '800')
            .style('fill', '#000')
            .style('stroke', '#fff')
            .style('stroke-width', '3px')
            .style('paint-order', 'stroke');
    }

    function updateNetworkColors(layers) {
        const layerPositions = calculateLayerPositions(layers)
        const lastLayerIndex = layerPositions.length - 1;
        const lastLayer = layerPositions[lastLayerIndex].positions;

        const colorScale = d3.scaleLinear()
            .domain([d3.min(lastLayer.map(d => d.weight)), d3.max(lastLayer.map(d => d.weight))])
            .range([0, 1]);

        svg.selectAll('.circle')
            .data(layerPositions.flatMap(d => d.positions))
            .attr('fill', d => {
                if (layerPositions[lastLayerIndex].positions.includes(d)) {
                    return d.weight > 0 ? d3.interpolateBlues(colorScale(d.weight)) : d3.interpolateOranges(colorScale(-d.weight));
                }
                return d.weight > 0 ? d3.interpolateBlues(d.weight) : d3.interpolateOranges(-d.weight);
        });
    }

    function update() { 
        frame++;
        

        //
        // Move Paddles
        //
        if (userInput === true) {
            playerPaddle.y += playerPaddle.dy;
            if (playerPaddle.y < 0) {
                playerPaddle.y = 0;
            } else if (playerPaddle.y + paddleHeight > canvas.height) {
                playerPaddle.y = canvas.height - paddleHeight;
            }
        } else {
            // Training partner will play perfectly 
            if (playerPaddle.y + playerPaddle.height / 2 < ball.y) {
                playerPaddle.y += paddleSpeed;
            } else {
                playerPaddle.y -= paddleSpeed;
            }
        }


        inputs = [
            4 * ((ball.x / canvas.width) - 0.5), 
            4 * ((ball.y / canvas.height) - 0.5), 
            (ball.dx / ballSpeed), 
            (ball.dy / ballSpeed), 
            4 * ((computerPaddle.y / canvas.height) - 0.5)
        ]
        // inputs = [1, 1]
        action = brain.forward(inputs);
        // console.log(inputs, action)
        // action = brain.forward([ball.x, ball.y, computerPaddle.y]);
        if (action == 1) {
            computerPaddle.y += paddleSpeed;
        } else if (action == 2) {
            computerPaddle.y -= paddleSpeed;
        }
        // Else do nothing 
        
        if (computerPaddle.y < 0) {
            computerPaddle.y = 0
        } else if (computerPaddle.y + paddleHeight > canvas.height) {
            computerPaddle.y = canvas.height - paddleHeight;
        }
        
        //
        // Move Ball
        //
        ball.x += ball.dx;
        ball.y += ball.dy;
        normalizedDistance = Math.abs(ball.y - computerPaddle.y) / canvas.height
        reward = 1 - 2 * normalizedDistance;  // This scales the reward from 1 (when they are equal) to -1 (when they are farthest apart)

        // Ball collision with top and bottom walls
        if (ball.y + ball.radius > canvas.height || ball.y - ball.radius < 0) {
            ball.dy *= -1;
        }

        // Ball collision with player paddle (considering rounded corners)
        if (ball.x - ball.radius < playerPaddle.x + playerPaddle.width &&
            ball.y > playerPaddle.y &&
            ball.y < playerPaddle.y + playerPaddle.height) {
            // Check if the ball is hitting the paddle's straight edges
            if (ball.y > playerPaddle.y + playerPaddle.radius &&
                ball.y < playerPaddle.y + playerPaddle.height - playerPaddle.radius) {
                ball.dx *= -1;
                ball.x = playerPaddle.x + playerPaddle.width + ball.radius; // prevent getting stuck
            } 
            // Check if the ball is hitting the paddle's rounded corners
            else {
                if (Math.hypot(ball.x - (playerPaddle.x + playerPaddle.width), ball.y - playerPaddle.y) <= ball.radius + playerPaddle.radius ||
                    Math.hypot(ball.x - (playerPaddle.x + playerPaddle.width), ball.y - (playerPaddle.y + playerPaddle.height)) <= ball.radius + playerPaddle.radius) {
                    ball.dx *= -1;
                    ball.x = playerPaddle.x + playerPaddle.width + ball.radius; // prevent getting stuck
                }
            }
        }

        // Ball collision with computer paddle (considering rounded corners)
        if (ball.x + ball.radius > computerPaddle.x &&
            ball.y > computerPaddle.y &&
            ball.y < computerPaddle.y + computerPaddle.height) {
            // Check if the ball is hitting the paddle's straight edges
            if (ball.y > computerPaddle.y + computerPaddle.radius &&
                ball.y < computerPaddle.y + computerPaddle.height - computerPaddle.radius) {
                ball.dx *= -1;
                ball.x = computerPaddle.x - ball.radius; // prevent getting stuck
                reward = 1.0; // Reward hitting the ball
                if (brain.epsilon <= opt.epsilon_min) {
                    hitCount++
                }
            } 
            // Check if the ball is hitting the paddle's rounded corners
            else {
                if (Math.hypot(ball.x - computerPaddle.x, ball.y - computerPaddle.y) <= ball.radius + computerPaddle.radius ||
                    Math.hypot(ball.x - computerPaddle.x, ball.y - (computerPaddle.y + computerPaddle.height)) <= ball.radius + computerPaddle.radius) {
                    ball.dx *= -1;
                    ball.x = computerPaddle.x - ball.radius; // prevent getting stuck
                    reward = 1.0; // Reward hitting the ball
                    if (brain.epsilon <= opt.epsilon_min) {
                        hitCount++
                    }
                }
            }
        }

        // Ball out of bounds: player loses
        if (ball.x - ball.radius < 0) {
            computerScore++;
            updateScore();
            if (userInput === true) {
                ballColor = computerColor;
                pauseFrames = pauseDuration;
            } else {
                resetBall();
            }
        }

        // Ball out of bounds: computer loses
        if (ball.x + ball.radius > canvas.width) {
            reward = -1.0 // Negative reward for failing to hit the ball
            playerScore++;
            updateScore();
            if (userInput === true) {
                ballColor = playerColor;
                pauseFrames = pauseDuration;
            } else {
                resetBall();
            }
            if (brain.epsilon <= opt.epsilon_min) {
                missCount++
            }
        }
        
        if (userInput === true) {
            brain.backward(reward);
        }
        // updateActionChart();
        if (frame == 100 && userInput != true || userInput === true && frame == 1) {
            drawNetwork(brain.value_net.layers)
        }
        if (frame > 1) {
            // console.log(playNetworkVisualization)
            if (playNetworkVisualization === true) {
                updateNetworkColors(brain.value_net.layers)
            }
        }
        if (frame > 100 && frame % 100 === 0) {
            if (brain.value_net.layers[brain.value_net.layers.length-1].out_act.w.some(Number.isNaN)) {
                console.log("ERROR! The array contains NaN values.");
            }
            addData()
        }
        if (frame % 10000 === 0) {
            console.log(brain)
        }

        // Gradually increase the ball's speed up to the maximum speed
        if (ball.speed < ball.maxSpeed) {
            ball.speed += ball.speedIncrement;
            ball.dx = ball.speed * Math.sign(ball.dx);
            ball.dy = ball.speed * Math.sign(ball.dy);
        }
    }

    let playerScore = 0;
    let computerScore = 0;
    const playerScoreElement = document.getElementById("playerScore");
    const computerScoreElement = document.getElementById("computerScore");

    function drawPaddle(x, y, width, height, color) {
        radius = 5
        context.fillStyle = color;
        // context.fillRect(x, y, width, height);
        context.beginPath();
        context.moveTo(x + radius, y);
        context.lineTo(x + width - radius, y);
        context.quadraticCurveTo(x + width, y, x + width, y + radius);
        context.lineTo(x + width, y + height - radius);
        context.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        context.lineTo(x + radius, y + height);
        context.quadraticCurveTo(x, y + height, x, y + height - radius);
        context.lineTo(x, y + radius);
        context.quadraticCurveTo(x, y, x + radius, y);
        context.closePath();
        context.fill();
    }

    function drawCircle(x, y, radius, color) {
        context.fillStyle = color;
        context.beginPath();
        context.arc(x, y, radius, 0, Math.PI * 2);
        context.closePath();
        context.fill();
    }

    function resetBall() {
        ball.x = canvas.width / 2;
        ball.y = Math.random() * (canvas.height - 200) + 100;
        ball.dx = ballSpeed * (Math.random() > 0.5 ? 1 : -1); // randomize direction
        ball.dy = ballSpeed * (Math.random() > 0.5 ? 1 : -1); // randomize direction
        ball.speed = ball.initialSpeed;
    }

    function updateScore() {
        if (userInput == true) {
            playerScoreElement.textContent = `Player: ${playerScore}`;
        } else {
            playerScoreElement.textContent = `Perfect Training Computer: ${playerScore}`;
        }
        computerScoreElement.textContent = `Computer: ${computerScore}`;
    }

    function draw() {
        context.clearRect(0, 0, canvas.width, canvas.height);
        drawPaddle(computerPaddle.x, computerPaddle.y, computerPaddle.width, computerPaddle.height, computerColor);
        drawPaddle(playerPaddle.x, playerPaddle.y, playerPaddle.width, playerPaddle.height, playerColor);
        drawCircle(ball.x, ball.y, ball.radius, ballColor);
    }

    function gameLoop() {   
        if (pauseFrames > 0) {
            pauseFrames--;
            if (pauseFrames === 0) {
                ballColor = "#FFF"; // Reset ball color
                resetBall(); // Reset the ball after the pause
            }
            draw();
        } else {
            update();
            draw();
        }
    }

    const playButton = document.getElementById('playButton');
    const trainButton = document.getElementById('trainButton');
    const fpsButtons = Array.from(document.querySelectorAll('#fps-buttons button'));
    const fpsButtonsDiv = document.getElementById('fps-buttons');
    const networkButton = document.getElementById('network-button');
    networkButton.addEventListener('click', pauseNetworkVisualization);
    let gameLoopInterval;
    let gameStarted = false;
    let userInput = false;

    playButton.addEventListener('click', () => {
        if (!gameStarted) {
            fps = 60; // frames per second
            intervalTime = 1000 / fps;
            gameLoopInterval = setInterval(gameLoop, intervalTime);
            gameStarted = true;
            playButton.style.display = 'none';
            trainButton.style.display = 'none';
            fpsButtonsDiv.style.display = 'flex';
            networkButton.style.display = 'flex';
            userInput = true
            playerPaddle.dy = 0
            fpsButtons[2].click();

            document.addEventListener("keydown", (event) => {
                if (event.key === "ArrowUp") {
                    playerPaddle.dy = -paddleSpeed;
                    event.preventDefault();
                } else if (event.key === "ArrowDown") {
                    playerPaddle.dy = paddleSpeed;
                    event.preventDefault();
                }
            });

            document.addEventListener("keyup", () => {
                playerPaddle.dy = 0;
            });

            canvas.addEventListener('click', () => {
                canvas.focus();
            });

            const defaultBrainJSON = {"layers":[{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"input"},{"out_depth":8,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":5,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":5,"w":{"0":0.006957650341207099,"1":-0.2280109816569348,"2":0.04532239434541955,"3":-0.34789304163577617,"4":0.02458450609043609}},{"sx":1,"sy":1,"depth":5,"w":{"0":0.0026716518306267984,"1":-0.46298118419168366,"2":-0.06960317854417822,"3":-0.07632296099080196,"4":0.42668392964120117}},{"sx":1,"sy":1,"depth":5,"w":{"0":-0.11726105582447759,"1":-0.48780117023311886,"2":-0.37635282493639927,"3":-0.10060747767526426,"4":0.18479471345288292}},{"sx":1,"sy":1,"depth":5,"w":{"0":0.015046836614927917,"1":-0.87814214036476,"2":0.00710488258176523,"3":-0.056591925300714864,"4":0.8758620772473326}},{"sx":1,"sy":1,"depth":5,"w":{"0":0.18559598892786672,"1":-0.4857619857039655,"2":-0.07357013591724318,"3":-0.14057434773330393,"4":-0.30593084296414086}},{"sx":1,"sy":1,"depth":5,"w":{"0":-0.21464564885007179,"1":-0.32888524284407755,"2":0.044304492256267744,"3":-0.07608997525394026,"4":-0.19535356961287653}},{"sx":1,"sy":1,"depth":5,"w":{"0":0.006101328544515375,"1":-0.3995911325844135,"2":0.0714565724014124,"3":-0.06565140249190209,"4":0.3531979148063858}},{"sx":1,"sy":1,"depth":5,"w":{"0":-0.009207690352869412,"1":-0.3081046524416349,"2":0.17548686872264466,"3":-0.0667025430711359,"4":0.14911888205371393}}],"biases":{"sx":1,"sy":1,"depth":8,"w":{"0":0.028738364385722755,"1":1.0883770136125208,"2":0.08464226743451718,"3":0.04718432713989186,"4":0.105057922781971,"5":0.09496441005518119,"6":0.8500707880241666,"7":0.24748251671152127}}},{"out_depth":8,"out_sx":1,"out_sy":1,"layer_type":"relu"},{"out_depth":16,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":8,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":8,"w":{"0":0.328138619984083,"1":-0.24341031711758804,"2":-0.08299758352448894,"3":-0.2713946619089551,"4":-0.09010767209865513,"5":-0.32661182105907544,"6":-0.5146072931870883,"7":-0.4924552219924063}},{"sx":1,"sy":1,"depth":8,"w":{"0":-0.006542447284531178,"1":0.4393923515810653,"2":0.017347560682065936,"3":-0.10890885274133759,"4":-0.22515688209337592,"5":-0.34978104705768626,"6":0.006784217676397713,"7":-0.19877120791692113}},{"sx":1,"sy":1,"depth":8,"w":{"0":-0.04658581287153846,"1":0.1971800753848248,"2":0.30365937580783425,"3":-0.33061661103044454,"4":0.2723410830006283,"5":0.5451593562653596,"6":-0.12794592491092815,"7":0.169179783885416}},{"sx":1,"sy":1,"depth":8,"w":{"0":0.1418297497798468,"1":0.2207050905906172,"2":-0.02575038630885696,"3":-0.44163415787417787,"4":0.4732597619054318,"5":0.33339947044054474,"6":-0.10532481575300912,"7":0.0015089931026817057}},{"sx":1,"sy":1,"depth":8,"w":{"0":-0.08955057874544259,"1":-0.2914765451472014,"2":0.39159368555569846,"3":-0.11322228070847014,"4":-0.4180038721918453,"5":0.011385548702617177,"6":-0.1652730054387246,"7":-0.22747952207206015}},{"sx":1,"sy":1,"depth":8,"w":{"0":0.14185769331420514,"1":0.12367197101596833,"2":0.19925225121757337,"3":0.2564678251983159,"4":0.033556773583474524,"5":-0.22480931943894863,"6":0.39810278929222015,"7":0.45178947590128854}},{"sx":1,"sy":1,"depth":8,"w":{"0":0.0989753953673568,"1":0.47816957725495124,"2":-0.3015016073038005,"3":-0.16506004377654407,"4":0.23855431911402872,"5":-0.10044538044073109,"6":0.10145486004957315,"7":-0.1753332698344328}},{"sx":1,"sy":1,"depth":8,"w":{"0":0.16910349656391122,"1":0.16907269723736235,"2":-0.13466447702743228,"3":-0.33174254281817134,"4":-0.14032311084567617,"5":0.21316767505357187,"6":0.2750345971835635,"7":0.21383471214228364}},{"sx":1,"sy":1,"depth":8,"w":{"0":0.5827404524432487,"1":0.19404330593890448,"2":-0.2529626913754907,"3":0.1396132697062058,"4":-0.4850882534828656,"5":0.46404387584441253,"6":-0.08589979578326593,"7":0.07247723859241052}},{"sx":1,"sy":1,"depth":8,"w":{"0":0.01698418543164604,"1":0.1528067625347512,"2":-0.16180940518974174,"3":0.26818366889342454,"4":-0.21067982052687037,"5":-0.09697969804626846,"6":-0.09841445631129835,"7":0.03844606051325796}},{"sx":1,"sy":1,"depth":8,"w":{"0":-0.09556588984528286,"1":0.2587485618156194,"2":0.15536548373517053,"3":0.031946802619255484,"4":0.23253954800027804,"5":-0.15090411306136292,"6":-0.4421180246045818,"7":-0.18796756100626358}},{"sx":1,"sy":1,"depth":8,"w":{"0":0.1441468073471929,"1":0.536743205432831,"2":0.08487378308381908,"3":-0.09884686872531426,"4":0.08947814425477654,"5":0.27547765246037814,"6":0.4909574240354945,"7":0.1383587544508338}},{"sx":1,"sy":1,"depth":8,"w":{"0":-0.03045614946862641,"1":0.05958265923068994,"2":-0.056202577302255585,"3":-0.02071191859334564,"4":-0.30720707653858625,"5":0.22281898713695078,"6":-0.10992346567292756,"7":0.07686479427346082}},{"sx":1,"sy":1,"depth":8,"w":{"0":-0.3508276855507375,"1":0.4439231644466148,"2":0.13022020089619787,"3":-0.9916669729378117,"4":-0.26533788842790684,"5":-0.2974370136534734,"6":0.7405846287041516,"7":0.21715096563257735}},{"sx":1,"sy":1,"depth":8,"w":{"0":-0.18781986865428169,"1":-0.1203702752440011,"2":-0.1297661325291967,"3":0.04655651400449834,"4":-0.06615407307056695,"5":-0.055494635680590765,"6":-0.036688472498291984,"7":0.31811045346423744}},{"sx":1,"sy":1,"depth":8,"w":{"0":0.1631468595065888,"1":-0.3337202252645593,"2":0.03745767339494205,"3":-0.10924645521950188,"4":-0.06510045915959875,"5":-0.14351262420912872,"6":0.12121057175490905,"7":-0.19034490504613194}}],"biases":{"sx":1,"sy":1,"depth":16,"w":{"0":0.32969775031263604,"1":0.14957164108530607,"2":0.14018633777533995,"3":0.18962287806232703,"4":-0.02165399374555403,"5":-0.16125534491476987,"6":0.12611291045413564,"7":0.10215742369045751,"8":0.06680209133943976,"9":0.06879684354721692,"10":-0.0019659643536913025,"11":-0.002883627271713218,"12":0.17508471504764214,"13":0.1443714849394087,"14":0.00996954980644318,"15":-0.02334740761236754}}},{"out_depth":16,"out_sx":1,"out_sy":1,"layer_type":"relu"},{"out_depth":16,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":16,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":16,"w":{"0":0.22718721218854993,"1":-0.18565935963276364,"2":0.12511747201425946,"3":0.01262343340866078,"4":0.10777786734458641,"5":-0.10642599269615448,"6":0.4639744861396208,"7":-0.01436043768156104,"8":-0.08945689993509147,"9":-0.06328392951962106,"10":0.2013552037200298,"11":-0.02429375220245975,"12":0.2599240048230079,"13":0.2816917616105948,"14":0.07175885970796833,"15":0.1080630994383355}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.13846176901763818,"1":0.03962707769308427,"2":-0.15148748060134185,"3":0.049607830910290016,"4":0.004832392563223687,"5":-0.030328361256278122,"6":0.16665410561629232,"7":0.06293017661019236,"8":-0.12972798451671988,"9":0.05022369092778965,"10":-0.06379443730372714,"11":-0.13803000960692757,"12":-0.030992558422779454,"13":-0.0035421886371321287,"14":-0.0034013952736520847,"15":0.0582207015561539}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.038110279294417494,"1":0.08620353343103518,"2":-0.056318954828693306,"3":0.005029460323105961,"4":0.1582392483786375,"5":-0.17071376064385782,"6":-0.12338797498946012,"7":-0.17360358146804192,"8":0.061401743262792345,"9":-0.11495606142399767,"10":0.03364130259652219,"11":0.09431529762478616,"12":0.11390724839702593,"13":-0.018663226562033917,"14":0.013573408141538006,"15":0.12416094658916452}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.2573864354098013,"1":0.1025530484398706,"2":-0.02379601010118088,"3":0.21595078704684698,"4":0.02732662175523795,"5":-0.16787283540995196,"6":0.008373172209068512,"7":-0.11142546156758983,"8":0.07923288697976054,"9":-0.022863297957221584,"10":0.08599291548863472,"11":0.29869177046733325,"12":-0.18290062458241263,"13":0.6187147072304605,"14":-0.13767159990217645,"15":-0.1561194379493006}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.17493612244944493,"1":0.3881278583266805,"2":0.19123141270357608,"3":0.1738444650736835,"4":-0.02657227095010705,"5":-0.12982171014234117,"6":0.19250164115616983,"7":0.36922523837595544,"8":-0.003516932833199951,"9":-0.0003271754085493981,"10":0.2576331352193627,"11":0.4307866076215882,"12":-0.08372727205059712,"13":0.8831320547051091,"14":0.13629523452344947,"15":0.14798231076976207}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.17846638181915728,"1":0.0595975096009392,"2":-0.04530113091370005,"3":-0.43096380497452336,"4":-0.34705252018543575,"5":0.3840361107388203,"6":-0.019600280521295466,"7":-0.19641841255465095,"8":0.0006343444878327449,"9":0.06509031767510944,"10":0.16884974665496313,"11":0.4356010643541235,"12":-0.19573771921904773,"13":-0.22377457027519737,"14":0.011123994162971338,"15":-0.20962545701062754}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.06374162237280252,"1":-0.047800264943901154,"2":0.058265244236745485,"3":-0.07657110052610794,"4":-0.06441119409400953,"5":0.14572677294868208,"6":-0.028238111773271832,"7":0.12636800528131323,"8":0.020047381666386598,"9":0.00836714268062259,"10":-0.010241203300998274,"11":-0.27943703707446055,"12":-0.1587064164841137,"13":-0.08114547373471266,"14":0.043754821498080736,"15":0.13333538714831797}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.13854249296183888,"1":-0.09421321230086324,"2":-0.06924580322766254,"3":0.01653608879504919,"4":-0.12204302630434843,"5":0.07700246723750824,"6":0.018090934523532755,"7":-0.11968422189251567,"8":0.06776131098372581,"9":-0.1517709573234775,"10":0.145957913940214,"11":-0.011522995199600643,"12":-0.04975657983426896,"13":0.39037933829289345,"14":-0.09736627609504145,"15":-0.07396054300108289}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.024652786366496437,"1":0.031101571960152213,"2":-0.1325828356558211,"3":0.09778206893519788,"4":-0.04049926933050183,"5":0.14346270797933314,"6":-0.0432497476856243,"7":-0.201588723639005,"8":-0.2014201077347158,"9":0.13582124525966593,"10":0.14782566459646004,"11":-0.09615227819125806,"12":-0.12086930171622275,"13":0.01943382802825206,"14":0.2555599811978115,"15":0.033499177934591694}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.034550180433030306,"1":0.01642301718982487,"2":-0.09472224337870654,"3":0.07416475678949705,"4":0.37224975956467515,"5":0.2543746066847847,"6":-0.07966105259501685,"7":-0.02280921252132472,"8":0.03729768321994681,"9":-0.018580412944788093,"10":0.04550714840924504,"11":0.18376276936064612,"12":0.1336536158553279,"13":0.039975798974347346,"14":0.2911144505427282,"15":-0.1482506042177695}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.38913631455312897,"1":0.03643577844277822,"2":0.025505972634319467,"3":-0.09626766062294388,"4":-0.03396786071100578,"5":0.03664044874267176,"6":-0.1859489683656048,"7":-0.08213273903593576,"8":-0.07782448014206715,"9":-0.167340443303159,"10":0.17587248143714124,"11":-0.1556959749037098,"12":0.04112578410323879,"13":0.032045259425563695,"14":0.09933497757644474,"15":0.005592304761878068}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.08200939959971297,"1":0.11849511525751925,"2":-0.01285544448917811,"3":-0.18852811378239315,"4":-0.026655338667054065,"5":-0.009971261853596754,"6":-0.1762214875744759,"7":0.12867370345830412,"8":-0.12235318677542839,"9":0.1373326028021135,"10":0.2494915784372436,"11":-0.06229088362801312,"12":0.06351514333759634,"13":0.050364925531095645,"14":-0.024778337787457534,"15":0.09558435534537126}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.08521352330565814,"1":-0.08133187149670941,"2":-0.1853482697152181,"3":0.13760004870908502,"4":0.3075479035210693,"5":-0.028696982804637415,"6":0.248001332667287,"7":-0.07719478181022922,"8":-0.02282744500820954,"9":-0.108341123167795,"10":0.00010710601746892496,"11":0.1463814236491739,"12":-0.17025820736816155,"13":-0.1609829475720109,"14":0.3733715823020369,"15":-0.07118867579511169}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.10721221031448822,"1":0.0048994303228045025,"2":0.028867550097511956,"3":-0.07265167138115372,"4":-0.02430798910564707,"5":-0.14396559994110403,"6":0.13325273343634936,"7":0.23547283363880744,"8":-0.08006083298737081,"9":0.21121514539431496,"10":-0.19850954791257563,"11":0.26579329102494476,"12":-0.0733012798105075,"13":0.1494527916463884,"14":0.17625839982476285,"15":-0.14144260975943318}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.24179233634388772,"1":0.2996207399972089,"2":-0.06221255218004203,"3":-0.0687704255017424,"4":-0.05486601932995511,"5":-0.004359893065645285,"6":0.24769828271892724,"7":0.012396167668006585,"8":-0.10306510467234739,"9":-0.0003661559692735442,"10":-0.15352434405869247,"11":0.06267724593973141,"12":0.2858117421637546,"13":0.0945153615486916,"14":0.06745536626421947,"15":-0.24711327889593376}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.07468825622337584,"1":-0.01346504890059204,"2":-0.24649536871641609,"3":0.18511395558919566,"4":-0.050841706320945416,"5":-0.06247998753881644,"6":-0.1971109518841861,"7":0.2692098683808617,"8":0.08287931407434308,"9":0.19711899520413456,"10":-0.036894785220174454,"11":-0.09046338008862845,"12":-0.0016412553487234972,"13":-0.08417022284814644,"14":0.1278859767036956,"15":0.2400008092355875}}],"biases":{"sx":1,"sy":1,"depth":16,"w":{"0":0.05988549108379257,"1":0.028176502701257544,"2":-0.010617374400846685,"3":0.030199800707710354,"4":-0.1400380843427725,"5":-0.026885639976127612,"6":0.035537647238542615,"7":0.022050022716873043,"8":-0.0008355052321758289,"9":0.11205604464276768,"10":0.30342336540540815,"11":0.004539651672756456,"12":0.07808220501536667,"13":0.12541636143178134,"14":0.06516722878311242,"15":0.07022980727684137}}},{"out_depth":16,"out_sx":1,"out_sy":1,"layer_type":"relu"},{"out_depth":8,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":16,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":16,"w":{"0":0.09074878442536737,"1":-0.08029419175538195,"2":0.1741652898415193,"3":0.3445299302401854,"4":0.5522113281295024,"5":-0.15183804860051633,"6":0.07067831246643172,"7":0.21504436440106117,"8":0.42358772466080585,"9":-0.02144402017541316,"10":0.11997577465836784,"11":0.16628398103017245,"12":0.11578596858146384,"13":-0.06164802089585803,"14":0.03798100655173436,"15":-0.04799577603905571}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.04709265052627382,"1":0.00042022983847938997,"2":-0.12981875320003858,"3":0.2130906799283864,"4":-0.1117752399077508,"5":0.14065086257521808,"6":-0.1370852151728017,"7":-0.0007485899416179777,"8":0.09324683928476134,"9":-0.09741040816366406,"10":-0.04346160241276406,"11":-0.04252622686949613,"12":-0.07690332888937508,"13":0.17465628255671603,"14":-0.09563141274235001,"15":0.05057280693547789}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.0404626718089161,"1":-0.007286251959416405,"2":0.2849380259791156,"3":0.11722680262343123,"4":0.2423747678276486,"5":-0.23919433536323492,"6":0.11924731586296418,"7":0.16021562666242112,"8":-0.09245647566252488,"9":0.15122404721078286,"10":0.07593016769568994,"11":0.2054322585743233,"12":-0.29460314189950887,"13":0.20350929607020896,"14":0.04270905675963577,"15":-0.1491858811540952}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.10944792330599429,"1":-0.0589039760468921,"2":0.14883576989071814,"3":0.2625580334022033,"4":0.1119652569758965,"5":-0.08870332617481992,"6":0.008104846310743869,"7":0.16960429345930148,"8":-0.1182112517906911,"9":0.19432930579127783,"10":-0.2059171838731686,"11":-0.248753295915245,"12":0.034321735837069225,"13":-0.18329204231427657,"14":0.10343174735299901,"15":0.3034402791203586}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.2381694757453401,"1":-0.21199065911918968,"2":-0.15241551596051858,"3":0.12649103782894255,"4":0.3105517300482844,"5":-0.3368030859225816,"6":-0.15895711170008053,"7":0.05164118957917682,"8":0.05766486862670459,"9":0.004926967060896891,"10":-0.19353588272234404,"11":-0.2635765696893977,"12":-0.2801309262854679,"13":-0.027806662066044825,"14":0.11886664778080828,"15":-0.21907385503575946}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.06924733985044905,"1":0.027686677803973686,"2":0.17942399130871634,"3":0.19222694452204273,"4":0.2238156897034151,"5":-0.028304328259138638,"6":0.17916005055466622,"7":-0.07129816927371684,"8":-0.07143030133550167,"9":-0.10178263061466862,"10":0.030228927136298767,"11":0.07015238649901856,"12":0.11221769263190015,"13":0.2888684488006805,"14":-0.06443122581126844,"15":0.03696273524823213}},{"sx":1,"sy":1,"depth":16,"w":{"0":0.3480774229137136,"1":0.15099130063910546,"2":0.04744642131653897,"3":0.48794896484645006,"4":0.9560406842906363,"5":-0.5246829611522914,"6":-0.018589139049778627,"7":0.15167260871994004,"8":-0.2256530187467129,"9":0.009358212846718759,"10":-0.4230523989377379,"11":0.16353898482909238,"12":-0.026524420914795677,"13":0.2188792547075569,"14":0.07872462904274419,"15":-0.03206350297606984}},{"sx":1,"sy":1,"depth":16,"w":{"0":-0.0489100937657615,"1":0.10632813056366947,"2":-0.15630350129090967,"3":-0.17611380394516504,"4":-0.0470809940188683,"5":0.3420051642995333,"6":0.033213951009148264,"7":-0.13113731419197858,"8":0.04751175467931609,"9":0.17351662237391538,"10":0.09345540769794972,"11":-0.1545175976564494,"12":-0.18083031923401122,"13":0.2105392973490787,"14":-0.10945335282136062,"15":-0.07469721175663122}}],"biases":{"sx":1,"sy":1,"depth":8,"w":{"0":-0.013005049012933239,"1":0.15963168411711676,"2":0.08668927109432537,"3":0.0030511440062292233,"4":0.06859520063789898,"5":-0.024963104868917035,"6":0.008410347245995748,"7":0.22272951467531962}}},{"out_depth":8,"out_sx":1,"out_sy":1,"layer_type":"relu"},{"out_depth":3,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":8,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":8,"w":{"0":0.7697074255915698,"1":-0.32698798077384644,"2":0.3243680818327652,"3":0.09368122328477257,"4":0.04346992886874705,"5":0.05207562671476195,"6":0.5538989347973335,"7":-0.15491825986120658}},{"sx":1,"sy":1,"depth":8,"w":{"0":0.0948594445462576,"1":0.3065978888160658,"2":0.14942212722188994,"3":-0.013105314029329166,"4":0.521024289401724,"5":0.03841097509815876,"6":0.8062722463362126,"7":-0.3909749456832344}},{"sx":1,"sy":1,"depth":8,"w":{"0":0.4330177334530485,"1":-0.2297451036383101,"2":0.0931262188443971,"3":0.34928905773456514,"4":0.10907646601623784,"5":0.3360470899494865,"6":0.7743347632698763,"7":0.08741917456905678}}],"biases":{"sx":1,"sy":1,"depth":3,"w":{"0":0.05500486106368548,"1":0.07083991093642235,"2":-0.18892884826234613}}},{"out_depth":3,"out_sx":1,"out_sy":1,"layer_type":"regression","num_inputs":3}]}
            brain.value_net.fromJSON(defaultBrainJSON);
            brain.learning = false;
        }
    });

    trainButton.addEventListener('click', () => {
        if (!gameStarted) {
            fps = 1000; // frames per second
            intervalTime = 1000 / fps;
            gameLoopInterval = setInterval(gameLoop, intervalTime);
            gameStarted = true;
            trainButton.style.display = 'none';
            playButton.style.display = 'none';
            fpsButtonsDiv.style.display = 'flex';
            networkButton.style.display = 'flex';
            fpsButtons[3].click();
            networkButton.click();
        }
    });

    function savenet() {
        var json = brain.value_net.toJSON();
        var text = JSON.stringify(json);
        document.getElementById('network-text').value = text;

        var blob = new Blob([text], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'pong_agent_network.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    document.getElementById('loadNetButton').onclick = function() {
        document.getElementById('fileInput').click();
    };

    document.getElementById('fileInput').onchange = function() {
        var file = this.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var text = e.target.result;
                var json = JSON.parse(text);
                brain.value_net.fromJSON(json);
                console.log("Network Loaded Successfully!");
            };
            brain.learning = false;
            reader.readAsText(file);
        }
    };

    // let gameLoopInterval = setInterval(gameLoop, intervalTime);

    </script>
</html>
